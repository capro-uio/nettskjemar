---
title: "Using nettskjemar"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using nettskjemar}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: sentence
---



Nettskjemar connects to version 3 of the [nettskjema api](https://api.nettskjema.no/v3/swagger-ui/index.html), and the main functionality here is to download data from a form into R.
Once you have [created a nettskjema client](setup_authentication.html), and set up your Renvironment locally, you can start accessing your forms.

## General recommendations

While functions to download data also have the option to turn off the codebook, i.e. return the data with the original questions as column names, this is **not recommended**.
Working with data in R in this format is very unpredictable, and we cannot guarantee that the functions in this package will act as expected.

Therefore, you are **highly advised** if you are using this package, to turn on the codebook in the Nettskjema portal for your form, and setting up a codebook for the entire form.

You can toggle the codebook for a form by going to the Nettskjema portal and entering your form.
Then proceed to "Settings" and then "General settings", and make sure "Codebook activated" is set to "Yes".
Once this is toggled, you will need to setup the codebook, either manually (advised) or by using the pre-filling functionality in Nettskjema.

You can read more about the details around the codebook on the [UiO webpages](https://www.uio.no/tjenester/it/adm-app/nettskjema/hjelp/kodebok.html) (only available in Norwegian).

## [Tidyverse](https://www.tidyverse.org/) compatible

The data returns in this package are developed to be tidyverse-compatible.
This means that those who are familiar with tidyverse, should find working with the data as retrieved from this package fairly easy.
If you want to learn about the tidyverse and how to use it, there are excellent resources for that on the [Tidyverse webpage](https://www.tidyverse.org/learn/).

## Download submissions

Perhaps at the core of this package is the ability to download submission answers to a form into a tibble (variation of a data.frame).


``` r
library(nettskjemar)
formid <- 123823

ndata <- nskj_get_data(formid)
ndata
#>   $submission_id                  $created  freetext
#> 1       27685292 2023-06-01T20:57:15+02:00 some text
#>   radio checkbox.questionnaires checkbox.events
#> 1     1                       1               1
#>   checkbox.logs dropdown radio_matrix.1
#> 1             0        4              1
#>   radio_matrix.2 radio_matrix.3 checkbox_matrix.1.IT
#> 1              2              2                    1
#>   checkbox_matrix.1.colleague
#> 1                           1
#>   checkbox_matrix.1.admin checkbox_matrix.1.union
#> 1                       0                       0
#>   checkbox_matrix.1.internet checkbox_matrix.2.IT
#> 1                          0                    0
#>   checkbox_matrix.2.colleague
#> 1                           0
#>   checkbox_matrix.2.admin checkbox_matrix.2.union
#> 1                       1                       0
#>   checkbox_matrix.2.internet       date  time
#> 1                          0 2023-06-01 12:00
#>           datetime number_decimal number_integer
#> 1 2023-06-12T13:33            4.5             77
#>   slider attachment_1 attachment_2 $answer_time_ms
#> 1      3    sølvi.png                        74630
#>  [ reached 'max' / getOption("max.print") -- omitted 2 rows ]
```

You will notice three columns that are prefixed with `$`.
These are columns automatically added by the Nettskema backend to your data, and the prefix is used to denote exactly this.

### Fetching Labelled Data

To retrieve labelled data with contextual information applied from the form's codebook, use the `labelled = TRUE` argument, which is the default behaviour.
Labelled data is a special type of data, inherited mostly from programs like Stata and SPSS, which incorporate rich meta-data into the data structure it self.
While the data are returned as labelled by default, the full scope and utilisation of labelled data cannot be done without explicitly importing the [labelled](https://larmarange.github.io/labelled/articles/labelled.html) package for expanding the functionality.

With labelled data, you still see the full question as asked in the labels of the data, as well as more detailed coding for the answer options.


``` r
library(labelled)

str(ndata)
#> 'data.frame':	3 obs. of  30 variables:
#>  $ $submission_id             : int  27685292 27685302 27685319
#>  $ $created                   : chr  "2023-06-01T20:57:15+02:00" "2023-06-01T20:58:33+02:00" "2023-06-01T20:59:50+02:00"
#>  $ freetext                   : chr  "some text" "another answer" ""
#>   ..- attr(*, "label")= chr "This is a question about something super important, where the user can input free text."
#>  $ radio                      : int+lbl [1:3]  1, -1, -1
#>    ..@ label : chr "How happy are we with Nettskjema?"
#>    ..@ labels: Named int  1 -1
#>    .. ..- attr(*, "names")= chr [1:2] "Very happy!" "Very unhappy!"
#>  $ checkbox.questionnaires    : int  1 0 1
#>  $ checkbox.events            : int  1 0 1
#>  $ checkbox.logs              : int  0 1 1
#>  $ dropdown                   : int+lbl [1:3] 4, 9, 4
#>    ..@ label : chr "Who is responsible with Nettskjema?"
#>    ..@ labels: Named int  4 9
#>    .. ..- attr(*, "names")= chr [1:2] "UiO" "OsloMet"
#>  $ radio_matrix.1             : int+lbl [1:3] 1, 3, 1
#>    ..@ label : chr "In the last month I have: written some grant applications"
#>    ..@ labels: Named int  1 2 3
#>    .. ..- attr(*, "names")= chr [1:3] "yes" "no" "not applicable"
#>  $ radio_matrix.2             : int+lbl [1:3] 2, 3, 1
#>    ..@ label : chr "In the last month I have: held a lecture"
#>    ..@ labels: Named int  1 2 3
#>    .. ..- attr(*, "names")= chr [1:3] "yes" "no" "not applicable"
#>  $ radio_matrix.3             : int+lbl [1:3] 2, 1, 1
#>    ..@ label : chr "In the last month I have: sent some e-mails"
#>    ..@ labels: Named int  1 2 3
#>    .. ..- attr(*, "names")= chr [1:3] "yes" "no" "not applicable"
#>  $ checkbox_matrix.1.IT       : int  1 0 0
#>  $ checkbox_matrix.1.colleague: int  1 0 1
#>  $ checkbox_matrix.1.admin    : int  0 0 0
#>  $ checkbox_matrix.1.union    : int  0 0 0
#>  $ checkbox_matrix.1.internet : int  0 1 1
#>  $ checkbox_matrix.2.IT       : int  0 0 1
#>  $ checkbox_matrix.2.colleague: int  0 0 1
#>  $ checkbox_matrix.2.admin    : int  1 1 1
#>  $ checkbox_matrix.2.union    : int  0 1 1
#>  $ checkbox_matrix.2.internet : int  0 0 0
#>  $ date                       : chr  "2023-06-01" "2023-02-07" "2022-09-28"
#>   ..- attr(*, "label")= chr "Choose a random date"
#>  $ time                       : chr  "12:00" "14:45" "05:11"
#>   ..- attr(*, "label")= chr "now choose a random time!"
#>  $ datetime                   : chr  "2023-06-12T13:33" "2024-02-15T08:55" "2022-03-03T07:29"
#>   ..- attr(*, "label")= chr "Lastly choose a date AND time!"
#>  $ number_decimal             : chr  "4.5" "2.2" "10"
#>   ..- attr(*, "label")= chr "Pick a number between 0 and 10!"
#>  $ number_integer             : int  77 45 98
#>   ..- attr(*, "label")= chr "Choose an integer between 0 and 100"
#>  $ slider                     : int  3 1 9
#>   ..- attr(*, "label")= chr "Choose a point on the slider!"
#>  $ attachment_1               : chr  "sølvi.png" "" ""
#>   ..- attr(*, "label")= chr "Upload a fun image!"
#>  $ attachment_2               : chr  "" "marius.jpeg" ""
#>   ..- attr(*, "label")= chr "This is an attachment2"
#>  $ $answer_time_ms            : int  74630 71313 70230
```

### Fetching Raw Data

To fetch the raw data as returned by the API (unprocessed), set the `asis = TRUE` argument.

Raw answers come in a very different format than the data as seen in the codebook and preview in Nettskjema portal.
The raw data have a timestamped format, per question for each submission.
This means the data comes in a _tall_ format (many rows per submission) rather than a wide format (one row per submission).
The raw data may provide those who have keen interest in the time a users spent between each question.
The data.frame this output will have one column that indicates which question the row is for, and another which is the response to that question.


``` r
# Fetch raw data
nskj_get_data(formid, asis = TRUE)
#>   formId submissionId  answerId elementId
#> 1 123823     27685292 158263133   1641697
#> 2 123823     27685292 158263124   1641698
#>   externalElementId textAnswer answerOptionIds
#> 1          freetext  some text                
#> 2             radio       <NA>         3879435
#>   externalAnswerOptionIds elementType
#> 1                            QUESTION
#> 2                       1       RADIO
#>           createdDate        modifiedDate
#> 1 2023-06-01T20:57:15 2023-06-01T20:57:15
#> 2 2023-06-01T20:57:15 2023-06-01T20:57:15
#>   subElementId answerAttachmentId filename mediaType
#> 1           NA                 NA     <NA>      <NA>
#> 2           NA                 NA     <NA>      <NA>
#>   size attachment.answerAttachmentId
#> 1   NA                            NA
#> 2   NA                            NA
#>   attachment.filename attachment.mediaType
#> 1                <NA>                 <NA>
#> 2                <NA>                 <NA>
#>   attachment.size
#> 1              NA
#> 2              NA
#>  [ reached 'max' / getOption("max.print") -- omitted 44 rows ]
```

Raw data cannot be labelled, and no other alterations have been made to the data.
They come exactly as the API returns them, so you may do what you need with them.



### Controlling checkbox output

**TODO: needs update and new solution for V3**

The Nettskjema survey tool includes the possibility to create checkboxes, i.e. giving the respondents the ability to select several options within a question.
How this returned as data is not clear cut.
The default behavior of Nettskjema portal is to create one enumerated column per checkbox, with the context of the column cells being the codebook value.
The default behavior of this package is to return the checkboxes as character strings with options selected separated by semi-colon (`;`).


``` r
# To start inspecting the data more
library(dplyr)

# These are the defaults, they don't need to be set
# They are just highlighted here
nettskjema_get_data(123823, 
                    checkbox_type = "string", 
                    checkbox_delim = ";") %>% 
  # this data has all checkbox questions coded with names like "checkbox"
  select(form_id, submission_id, starts_with("checkbox"))
#> Error in nettskjema_get_data(123823, checkbox_type = "string", checkbox_delim = ";"): could not find function "nettskjema_get_data"
```

    Form 123823 has 4 responses to download.
    # A tibble: 4 × 5
      form_id submission_id checkbox checkbox_matrix_1 checkbox_matrix_2
        <dbl> <chr>         <chr>    <chr>             <chr>            
    1  123823 16785801      1;2      1;2               1;2              
    2  123823 16779763      2        1                 NA               
    3  123823 16509317      1        1                 1                
    4  123823 16508664      1        1;2               1    

these can be separated into rows if wanted, using tidyverse syntax.


``` r
nettskjema_get_data(123823, 
                    checkbox_type = "string", 
                    checkbox_delim = ";") %>% 
  select(form_id, submission_id, starts_with("checkbox")) %>% 
  separate_rows(checkbox)
#> Error in separate_rows(., checkbox): could not find function "separate_rows"
```

    Form 123823 has 4 responses to download.
    # A tibble: 5 × 5
      form_id submission_id checkbox checkbox_matrix_1 checkbox_matrix_2
        <dbl> <chr>         <chr>    <chr>             <chr>            
    1  123823 16785801      1        1;2               1;2              
    2  123823 16785801      2        1;2               1;2              
    3  123823 16779763      2        1                 NA               
    4  123823 16509317      1        1                 1                
    5  123823 16508664      1        1;2               1       

Another way is to request the checkbox data returned as list columns


``` r
nettskjema_get_data(123823, 
                    checkbox_type = "list") %>% 
  select(form_id, submission_id, starts_with("checkbox")) 
#> Error in nettskjema_get_data(123823, checkbox_type = "list"): could not find function "nettskjema_get_data"
```

    Form 123823 has 4 responses to download.
    # A tibble: 4 × 5
      form_id submission_id checkbox  checkbox_matrix_1 checkbox_matrix_2
        <dbl> <chr>         <list>    <list>            <list>           
    1  123823 16785801      <chr [2]> <chr [2]>         <chr [2]>        
    2  123823 16779763      <chr [1]> <chr [1]>         <chr [1]>        
    3  123823 16509317      <chr [1]> <chr [1]>         <chr [1]>        
    4  123823 16508664      <chr [1]> <chr [2]>         <chr [1]>       

Similar type action for list columns as for string with `separate_rows` is to `unnest` the list column.


``` r
nettskjema_get_data(123823, 
                    checkbox_type = "list") %>% 
  select(form_id, submission_id, starts_with("checkbox")) %>% 
  unnest(checkbox)
#> Error in unnest(., checkbox): could not find function "unnest"
```

    Form 123823 has 4 responses to download.
    # A tibble: 5 × 5
      form_id submission_id checkbox checkbox_matrix_1 checkbox_matrix_2
        <dbl> <chr>         <chr>    <list>            <list>           
    1  123823 16785801      1        <chr [2]>         <chr [2]>        
    2  123823 16785801      2        <chr [2]>         <chr [2]>        
    3  123823 16779763      2        <chr [1]>         <chr [1]>        
    4  123823 16509317      1        <chr [1]>         <chr [1]>        
    5  123823 16508664      1        <chr [2]>         <chr [1]>         

The last option is to return the data where each checkbox is a column, with a binary indicator showing if the option was selected (`1`) or not (`0`).


``` r
nettskjema_get_data(123823, 
                    checkbox_type = "columns") %>% 
  select(form_id, submission_id, starts_with("checkbox"))
#> Error in nettskjema_get_data(123823, checkbox_type = "columns"): could not find function "nettskjema_get_data"
```

    Form 123823 has 4 responses to download.
    # A tibble: 4 × 8
      form_id submission_id checkbox_1 checkbox_2 checkbox_matrix_1_1 checkbox_matrix_1_2
        <dbl> <chr>              <int>      <int>               <int>               <int>
    1  123823 16785801               1          1                   1                   1
    2  123823 16779763               0          1                   1                   0
    3  123823 16509317               1          0                   1                   0
    4  123823 16508664               1          0                   1                   1
    # … with 2 more variables: checkbox_matrix_2_1 <int>, checkbox_matrix_2_2 <int>    

There is a gotcha with this last option.
Currently, there is no way to indicate values that should actually be `NA`, i.e. if the question is optional there is no way to know if lack of selection means the item was explicitly not selected or someone just skipped the question.


## Getting an overview of responses

If you want a quick idea of what your data contains, we recommend using the `skim()` function from the {skimr} package.


``` r
skimr::skim(ndata)
```


Table: Data summary

|                         |      |
|:------------------------|:-----|
|Name                     |ndata |
|Number of rows           |3     |
|Number of columns        |30    |
|_______________________  |      |
|Column type frequency:   |      |
|character                |8     |
|numeric                  |22    |
|________________________ |      |
|Group variables          |None  |


**Variable type: character**

|skim_variable  | n_missing| complete_rate| min| max| empty| n_unique| whitespace|
|:--------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|
|$created       |         0|             1|  25|  25|     0|        3|          0|
|freetext       |         0|             1|   0|  14|     1|        3|          0|
|date           |         0|             1|  10|  10|     0|        3|          0|
|time           |         0|             1|   5|   5|     0|        3|          0|
|datetime       |         0|             1|  16|  16|     0|        3|          0|
|number_decimal |         0|             1|   2|   3|     0|        3|          0|
|attachment_1   |         0|             1|   0|   9|     2|        2|          0|
|attachment_2   |         0|             1|   0|  11|     2|        2|          0|


**Variable type: numeric**

|skim_variable               | n_missing| complete_rate|        mean|      sd|       p0|        p25|      p50|        p75|     p100|hist  |
|:---------------------------|---------:|-------------:|-----------:|-------:|--------:|----------:|--------:|----------:|--------:|:-----|
|$submission_id              |         0|             1| 27685304.33|   13.65| 27685292| 27685297.0| 27685302| 27685310.5| 27685319|▇▇▁▁▇ |
|radio                       |         0|             1|       -0.33|    1.15|       -1|       -1.0|       -1|        0.0|        1|▇▁▁▁▃ |
|checkbox.questionnaires     |         0|             1|        0.67|    0.58|        0|        0.5|        1|        1.0|        1|▃▁▁▁▇ |
|checkbox.events             |         0|             1|        0.67|    0.58|        0|        0.5|        1|        1.0|        1|▃▁▁▁▇ |
|checkbox.logs               |         0|             1|        0.67|    0.58|        0|        0.5|        1|        1.0|        1|▃▁▁▁▇ |
|dropdown                    |         0|             1|        5.67|    2.89|        4|        4.0|        4|        6.5|        9|▇▁▁▁▃ |
|radio_matrix.1              |         0|             1|        1.67|    1.15|        1|        1.0|        1|        2.0|        3|▇▁▁▁▃ |
|radio_matrix.2              |         0|             1|        2.00|    1.00|        1|        1.5|        2|        2.5|        3|▇▁▇▁▇ |
|radio_matrix.3              |         0|             1|        1.33|    0.58|        1|        1.0|        1|        1.5|        2|▇▁▁▁▃ |
|checkbox_matrix.1.IT        |         0|             1|        0.33|    0.58|        0|        0.0|        0|        0.5|        1|▇▁▁▁▃ |
|checkbox_matrix.1.colleague |         0|             1|        0.67|    0.58|        0|        0.5|        1|        1.0|        1|▃▁▁▁▇ |
|checkbox_matrix.1.admin     |         0|             1|        0.00|    0.00|        0|        0.0|        0|        0.0|        0|▁▁▇▁▁ |
|checkbox_matrix.1.union     |         0|             1|        0.00|    0.00|        0|        0.0|        0|        0.0|        0|▁▁▇▁▁ |
|checkbox_matrix.1.internet  |         0|             1|        0.67|    0.58|        0|        0.5|        1|        1.0|        1|▃▁▁▁▇ |
|checkbox_matrix.2.IT        |         0|             1|        0.33|    0.58|        0|        0.0|        0|        0.5|        1|▇▁▁▁▃ |
|checkbox_matrix.2.colleague |         0|             1|        0.33|    0.58|        0|        0.0|        0|        0.5|        1|▇▁▁▁▃ |
|checkbox_matrix.2.admin     |         0|             1|        1.00|    0.00|        1|        1.0|        1|        1.0|        1|▁▁▇▁▁ |
|checkbox_matrix.2.union     |         0|             1|        0.67|    0.58|        0|        0.5|        1|        1.0|        1|▃▁▁▁▇ |
|checkbox_matrix.2.internet  |         0|             1|        0.00|    0.00|        0|        0.0|        0|        0.0|        0|▁▁▇▁▁ |
|number_integer              |         0|             1|       73.33|   26.69|       45|       61.0|       77|       87.5|       98|▇▁▁▇▇ |
|slider                      |         0|             1|        4.33|    4.16|        1|        2.0|        3|        6.0|        9|▇▇▁▁▇ |
|$answer_time_ms             |         0|             1|    72057.67| 2292.57|    70230|    70771.5|    71313|    72971.5|    74630|▇▇▁▁▇ |



If you want a quick idea of data types and missing values, the `vis_dat()` function from the {visdat} package is a great graphical tool.


``` r
visdat::vis_dat(ndata)
```

![plot of chunk nskj_vidat](figure/nskj_vidat-1.png)


