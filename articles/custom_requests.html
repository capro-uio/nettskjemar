<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Building custom requests • nettskjemar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building custom requests">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nettskjemar</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/nettskjemar.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Working with data</h6></li>
    <li><a class="dropdown-item" href="../articles/nettskjemar.html">Retrieving all form submissions</a></li>
    <li><a class="dropdown-item" href="../articles/labelled_data.html">Labelled data</a></li>
    <li><a class="dropdown-item" href="../articles/submissions.html">Single submissions</a></li>
    <li><a class="dropdown-item" href="../articles/attachments.html">Retrieving attachments</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>User auth and information</h6></li>
    <li><a class="dropdown-item" href="../articles/authentication.html">Authentication setup</a></li>
    <li><a class="dropdown-item" href="../articles/forms.html">Viewing all forms</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Other requests</h6></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Retrieving form meta-data</a></li>
    <li><a class="dropdown-item" href="../articles/custom_requests.html">Running custom requests</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/capro-uio/nettskjemar/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Building custom requests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/capro-uio/nettskjemar/blob/main/vignettes/custom_requests.Rmd" class="external-link"><code>vignettes/custom_requests.Rmd</code></a></small>
      <div class="d-none name"><code>custom_requests.Rmd</code></div>
    </div>

    
    
<p>This package focuses on retrieving information from the Nettskjema
API, primarily regarding collected data and meta-data for forms. There
are, however, several endpoints (functionalities) of the API that are
currently not covered here. These most often pertain to sending data
<em>to</em> the API, either for creating new forms, updating meta-data
or even submitting submissions.</p>
<p>In order to facilitate users potential wish to connect to these
endpoints too, the base function <code><a href="../reference/ns_req.html">ns_req()</a></code> is available to
build the query you are after. This vignette will in short show how you
can combine this function, with functionality from the <a href="https://httr2.r-lib.org/index.html" class="external-link">httr2</a> package to create
custom requests to the Nettskjema API.</p>
<div class="section level2">
<h2 id="setting-up-a-custom-get-request">Setting up a custom GET request<a class="anchor" aria-label="anchor" href="#setting-up-a-custom-get-request"></a>
</h2>
<p>First, you will need to identify the functionality you want to use in
the <a href="https://nettskjema.no/apidoc" class="external-link">Nettskjema API docs</a>.</p>
<p>Let’s assume you want to update the settings for a form. To do this,
we can first retrieve the settings as they are stored, alter the setting
we want to alter, then send that back to Nettskjema.</p>
<p>In the API docs, the URL for getting Settings for a form is shown as
<code>/api/v3/form/{formId}/settings</code>, which is the URL we need to
build to access this information. The <code><a href="../reference/ns_req.html">ns_req()</a></code> function,
will build the URL up to including <code>/api/v3</code> and we need to
add the rest.</p>
<p>The <code><a href="../reference/ns_req.html">ns_req()</a></code> function looks like this</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ns_req</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">(</span><span class="st">"https://nettskjema.no/api/v3/"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/ns_req_auth.html">ns_req_auth</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>where <code>ns_auth()</code> is sets up the authentication client as
described in the <a href="authentication.html">Authentication
vignette</a>. Meaning if we use it, the important parts that make sure
you connect to the correct API with the correct credentials.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/CAPRO-UiO/nettskjemar" class="external-link">nettskjemar</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ns_req.html">ns_req</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">&lt;httr2_request&gt;</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">GET</span> https://nettskjema.no/api/v3/</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Body</span>: empty</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Policies:</span></span></span>
<span><span class="co">#&gt; * <span style="color: #00BB00;">auth_sign </span>: &lt;list&gt;</span></span>
<span><span class="co">#&gt; * <span style="color: #00BB00;">auth_oauth</span>: TRUE</span></span></code></pre></div>
<p>As you can see, the output here shows the URL until the
<code>v3</code> section, and also that there is Authorization added,
which the function does in the background for you with the
authentication information you have set up as shown in the <a href="authentication.html">Authentication vignette</a>.</p>
<p>From there, we need to use functions from {httr2} to build the
remaining url.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr2.r-lib.org" class="external-link">httr2</a></span><span class="op">)</span></span>
<span><span class="va">formid</span> <span class="op">&lt;-</span> <span class="fl">123823</span></span>
<span></span>
<span><span class="fu"><a href="../reference/ns_req.html">ns_req</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html" class="external-link">req_url_path_append</a></span><span class="op">(</span><span class="st">"form"</span>, <span class="va">formid</span>, <span class="st">"settings"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">&lt;httr2_request&gt;</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">GET</span> https://nettskjema.no/api/v3/form/123823/settings</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Body</span>: empty</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Policies:</span></span></span>
<span><span class="co">#&gt; * <span style="color: #00BB00;">auth_sign </span>: &lt;list&gt;</span></span>
<span><span class="co">#&gt; * <span style="color: #00BB00;">auth_oauth</span>: TRUE</span></span></code></pre></div>
<p>Now, you can see that the path is as requested in the API
documentation. But the request has not been submitted yet! So far, we
have just been creating the command we want to send to the API. To send
the request, we need to use the <code>req_perform</code> function from
httr2.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ns_req.html">ns_req</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html" class="external-link">req_url_path_append</a></span><span class="op">(</span><span class="st">"form"</span>, <span class="va">formid</span>, <span class="st">"settings"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">response</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">&lt;httr2_response&gt;</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">GET</span> https://nettskjema.no/api/v3/form/123823/settings</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Status</span>: 200 OK</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Content-Type</span>: application/json</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Body</span>: In memory (2047 bytes)</span></span></code></pre></div>
<p>In this case, we also saved the output from the request to a variable
in our environment, so we can work with what we received, without having
to send the request more times.</p>
<p>The <code>response</code> object here shows stats <code>200</code>
which is the standard response when a request has been fulfilled without
error. If you receive errors, httr2 will show this clearly, and you will
need to debug what is wrong.</p>
<p>Now that we have the response, we need to “unpack” it, so we can get
the data that was sent with the response, which are all the settings for
the form. We use httr2 functions to do this. In general, most of the
Nettskjema API responses come as <code>json</code> in the “body” of the
response (this is API lingo, just go with it.).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">settings_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_json</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span></span>
<span><span class="va">settings_data</span></span>
<span><span class="co">#&gt; $formId</span></span>
<span><span class="co">#&gt; [1] 123823</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $formType</span></span>
<span><span class="co">#&gt; [1] "DEFAULT"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $scoreResultDisplayType</span></span>
<span><span class="co">#&gt; [1] "NONE"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $openFrom</span></span>
<span><span class="co">#&gt; [1] "2023-06-01T20:55:49"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $openTo</span></span>
<span><span class="co">#&gt; [1] "2024-06-02T02:00:02"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $title</span></span>
<span><span class="co">#&gt; [1] "API test form"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $titleShort</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editorsContactEmail</span></span>
<span><span class="co">#&gt; [1] "a.m.mowinckel@psykologi.uio.no"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editorsContactUrl</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $collectsPersonalData</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sensitivePersonalDataCollected</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $personalDataSharedOutsideInstitutionWith</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $personalDataPurposeTypes</span></span>
<span><span class="co">#&gt; $personalDataPurposeTypes[[1]]</span></span>
<span><span class="co">#&gt; [1] "OTHER"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $personalDataPurposeDescription</span></span>
<span><span class="co">#&gt; [1] "Testing the API"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $languageCode</span></span>
<span><span class="co">#&gt; [1] "nb"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $shouldHideProgressBar</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $shouldPreventDataManipulation</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $codebookActivated</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $afterDeliveryForwardFormIds</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $maxSubmissionsForm</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $maxSubmissionsPerson</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $canNotAnswerMessage</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $respondentGroup</span></span>
<span><span class="co">#&gt; [1] "ALL"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $deleteSubmissionsAfterNumberOfDays</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $postponable</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $retainRespondentAccessAfterDelivery</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sendingReceiptToRespondent</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $receiptText</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editorsSubmissionEmailType</span></span>
<span><span class="co">#&gt; [1] "NONE"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editorsSubmissionEmails</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $deliveryDestination</span></span>
<span><span class="co">#&gt; [1] "DATABASE"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $emailInvitationText</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $emailReminderText</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $automaticReminderIntervalInDays</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $recurringInvitationNumber</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $recurringInvitationIntervalInDays</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $tsdPgpPublicKeyFingerprint</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editorCryptKeyDatabaseEncrypted</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editorCryptKeyDatabaseEncryptedFingerprint</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors</span></span>
<span><span class="co">#&gt; $editors[[1]]</span></span>
<span><span class="co">#&gt; $editors[[1]]$personId</span></span>
<span><span class="co">#&gt; [1] 58096</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[1]]$username</span></span>
<span><span class="co">#&gt; [1] "athanasm@uio.no"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[1]]$name</span></span>
<span><span class="co">#&gt; [1] "Athanasia Monika Mowinckel"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[1]]$email</span></span>
<span><span class="co">#&gt; [1] "a.m.mowinckel@psykologi.uio.no"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[1]]$type</span></span>
<span><span class="co">#&gt; [1] "LOCAL"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[2]]</span></span>
<span><span class="co">#&gt; $editors[[2]]$personId</span></span>
<span><span class="co">#&gt; [1] 132</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[2]]$username</span></span>
<span><span class="co">#&gt; [1] "areg@uio.no"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[2]]$name</span></span>
<span><span class="co">#&gt; [1] "Are Dag Gulbrandsen"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[2]]$email</span></span>
<span><span class="co">#&gt; [1] "areg@uio.no"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[2]]$type</span></span>
<span><span class="co">#&gt; [1] "LOCAL"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[3]]</span></span>
<span><span class="co">#&gt; $editors[[3]]$personId</span></span>
<span><span class="co">#&gt; [1] 3439404</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[3]]$username</span></span>
<span><span class="co">#&gt; [1] "ccda25ce-8256-4c6f-ba71-7a4357dc6caf@apiclient"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[3]]$name</span></span>
<span><span class="co">#&gt; [1] "nettskjemar"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[3]]$email</span></span>
<span><span class="co">#&gt; [1] "athanasm@uio.no"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $editors[[3]]$type</span></span>
<span><span class="co">#&gt; [1] "API_CLIENT"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $personsWithCopyPermission</span></span>
<span><span class="co">#&gt; list()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $netgroupsEditor</span></span>
<span><span class="co">#&gt; list()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $netgroupsWithCopyPermission</span></span>
<span><span class="co">#&gt; list()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $consentForm</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $randomizedOrder</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $supportuser</span></span>
<span><span class="co">#&gt; $supportuser$theme</span></span>
<span><span class="co">#&gt; [1] "DEFAULT"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $superuser</span></span>
<span><span class="co">#&gt; $superuser$afterDeliveryForwardUrl</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $superuser$afterDeliveryForwardCodebookValues</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $superuser$receiptPageScript</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $isDictaphone</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $globalCopyPermissionEnabled</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $titleForLogging</span></span>
<span><span class="co">#&gt; [1] "\"API test form\" (id: 123823)"</span></span></code></pre></div>
<p>Using the <code><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_json()</a></code> function from httr2, will
automatically unpack the <code>json</code> into a R list-format, so we
can more easily work with it.</p>
<p>There are endpoints in the Nettskjema API that will not send
<code>json</code>, for instance the ones where you retrieve
<em>files</em> from the server (excel, SPSS, PDF), these come in
<em>binary</em> form. While, this package contains functions to retrieve
those specific files for you, we mention this because you will need to
pay attention to the format of the response to know how to unpack the
data correctly.</p>
</div>
<div class="section level2">
<h2 id="setting-up-a-custom-post-request">Setting up a custom POST request<a class="anchor" aria-label="anchor" href="#setting-up-a-custom-post-request"></a>
</h2>
<p>So far, we have focused on <code>GET</code> requests, which retrieve
information from the API. A <code>POST</code> request sends information
<em>to</em> the API for storing, and is a little more work. This is
because <code>POST</code> (or <code>PUT</code> or <code>PATCH</code>)
also send information in the “body” of the request, with the information
you want stored. You will need to know what format this information
should have, and how to set it up to make it work correctly. This can
require a lot of trial and error to get working correctly.</p>
<p>Since we now have the full settings for a form, let us change a
setting so we can see how to achieve this. There is an element that
controls if the user can postpone the survey as they are answering
it.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">settings_data</span><span class="op">$</span><span class="va">postponable</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>For this form, it’s set to <code>FALSE</code> because its just a
simple test form I didn’t turn this feature on. We will turn it on by
setting the value to <code>TRUE</code>.</p>
<p>There are several things we need to pay particular attention to in
the documentation when we send these types of requests:</p>
<ol style="list-style-type: decimal">
<li>The METHOD (POST, PUT, PATCH)</li>
<li>The URL endpoint</li>
<li>The information we need to send</li>
</ol>
<p>For altering settings, these are:</p>
<ol style="list-style-type: decimal">
<li>PATCH</li>
<li>/api/v3/form/{formId}/settings</li>
<li><code>additionalProperty = string</code></li>
</ol>
<p>The first two bits were easy enough to figure out, but the last one
there might require some trial and error. I’m not entirely sure what
it’s telling me the body contents should be, so I’ll be doing some
assumptions. Since its a <code>PATCH</code> method, and the docs is not
explicitly saying we need to send all settings, I’m hoping I can send
just the property I want to alter in a list (which httr2 will help me
turn into a json that API expects). Since the URL endpoints is the same
as when getting the settings, what we need to do it use the same
information, but change the method with httr2.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ns_req.html">ns_req</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html" class="external-link">req_url_path_append</a></span><span class="op">(</span><span class="st">"form"</span>, <span class="va">formid</span>, <span class="st">"settings"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_method.html" class="external-link">req_method</a></span><span class="op">(</span><span class="st">"PATCH"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">&lt;httr2_request&gt;</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">PATCH</span> https://nettskjema.no/api/v3/form/123823/settings</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Body</span>: empty</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Policies:</span></span></span>
<span><span class="co">#&gt; * <span style="color: #00BB00;">auth_sign </span>: &lt;list&gt;</span></span>
<span><span class="co">#&gt; * <span style="color: #00BB00;">auth_oauth</span>: TRUE</span></span></code></pre></div>
<p>Ok, we can see now that the method is correct, the URL is correct,
but the body is empty.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ns_req.html">ns_req</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html" class="external-link">req_url_path_append</a></span><span class="op">(</span><span class="st">"form"</span>, <span class="va">formid</span>, <span class="st">"settings"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_method.html" class="external-link">req_method</a></span><span class="op">(</span><span class="st">"PATCH"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_body.html" class="external-link">req_body_json</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      postponable <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">&lt;httr2_request&gt;</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">PATCH</span> https://nettskjema.no/api/v3/form/123823/settings</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Body</span>: JSON data</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Policies:</span></span></span>
<span><span class="co">#&gt; * <span style="color: #00BB00;">auth_sign </span>: &lt;list&gt;</span></span>
<span><span class="co">#&gt; * <span style="color: #00BB00;">auth_oauth</span>: TRUE</span></span></code></pre></div>
<p>Things look kind of correct now, we’re still not sure about the body
setup, but we will send the request and see what happens.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ns_req.html">ns_req</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html" class="external-link">req_url_path_append</a></span><span class="op">(</span><span class="st">"form"</span>, <span class="va">formid</span>, <span class="st">"settings"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_method.html" class="external-link">req_method</a></span><span class="op">(</span><span class="st">"PATCH"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_body.html" class="external-link">req_body_json</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      postponable <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `req_perform()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> HTTP 400 Bad Request.</span></span></code></pre></div>
<p>That didn’t work, but why? We’ve not got any further error message,
but there might be more information in the body of the response, even if
it erred. Erring API calls like these are actually valid proper
responses, so we can explore them just like normal responses. If you
didn’t store the response, like I did, you can still explore it without
doing the call again. httr2 has functionality to capture the last
response even after the fact!</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://httr2.r-lib.org/reference/last_response.html" class="external-link">last_response</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_json</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span> <span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "Valideringsfeil"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $errors</span></span>
<span><span class="co">#&gt; $errors$postponable</span></span>
<span><span class="co">#&gt; $errors$postponable[[1]]</span></span>
<span><span class="co">#&gt; [1] "Mellomlagring er bare tillatt for skjemaer med FEIDE-respondenter, er satt til å samle inn personopplysninger og som leverer til Nettskjema"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $confirmForceCleanupErrors</span></span>
<span><span class="co">#&gt; named list()</span></span></code></pre>
<p>As we can see, we get a nice clear message about what has erred. The
form I’m trying to change doesn’t meet the pre-requisites for allowing
postponing, so we cannot alter that setting!</p>
<p>We can try changing another setting in stead, but we have actually
already verified that our calls to the API is working as expected. We
can try altering two settings at once, and see what happens.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show old settings</span></span>
<span><span class="va">settings_data</span><span class="op">$</span><span class="va">personalDataPurposeDescription</span></span>
<span><span class="co">#&gt; [1] "Testing the API"</span></span>
<span><span class="va">settings_data</span><span class="op">$</span><span class="va">shouldHideProgressBar</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="co"># Set new settings</span></span>
<span><span class="fu"><a href="../reference/ns_req.html">ns_req</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html" class="external-link">req_url_path_append</a></span><span class="op">(</span><span class="st">"form"</span>, <span class="va">formid</span>, <span class="st">"settings"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_method.html" class="external-link">req_method</a></span><span class="op">(</span><span class="st">"PATCH"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_body.html" class="external-link">req_body_json</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      personalDataPurposeDescription <span class="op">=</span> <span class="st">"Testing the API"</span>,</span>
<span>      shouldHideProgressBar <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">&lt;httr2_response&gt;</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">PATCH</span> https://nettskjema.no/api/v3/form/123823/settings</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Status</span>: 204 No Content</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Body</span>: None</span></span></code></pre></div>
<p>Now we are cooking, we are getting a 204 back, which is a positive <a href="https://www.webcron.org/en/http-codes" class="external-link">status code</a> from an
API. The response also says there is no content, and nothing in the
body, so there is nothing more to inspect here.</p>
<p>Lets retrieve the settings again and see if we can verify our selves
that the settings have indeed changed</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">settings_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ns_req.html">ns_req</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html" class="external-link">req_url_path_append</a></span><span class="op">(</span><span class="st">"form"</span>, <span class="va">formid</span>, <span class="st">"settings"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_json</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">settings_new</span><span class="op">$</span><span class="va">personalDataPurposeDescription</span></span>
<span><span class="co">#&gt; [1] "Testing the API"</span></span>
<span><span class="va">settings_new</span><span class="op">$</span><span class="va">shouldHideProgressBar</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>We’ve now confirmed we have altered some settings in the test form.
Hopefully, this gives an idea of how you can build more custom requests
to the API.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Athanasia Mo Mowinckel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
